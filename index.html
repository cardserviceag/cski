<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BuddyKI Chat</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #fafafa;
    }
    #root {
      max-width: 600px;
      margin: 20px auto;
    }
    .chat {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      height: 400px;
      overflow-y: auto;
      margin-bottom: 10px;
      background: #fff;
    }
    .msg {
      margin: 8px 0;
    }
    .msg.user {
      text-align: right;
    }
    .bubble {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 16px;
      background: #eee;
    }
    .msg.user .bubble {
      background: #007bff;
      color: #fff;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    function detectEmotion(input) {
      const text = input.toLowerCase();
      if (text.match(/traurig|einsam|deprimiert/)) return "sad";
      if (text.match(/glÃ¼cklich|freude|zufrieden/)) return "happy";
      if (text.match(/stress|arbeit|Ã¼berlastet/)) return "stressed";
      if (text.match(/schmerz|weh|verletzung/)) return "pain";
      if (text.match(/angst|sorge|unsicher/)) return "fear";
      return "neutral";
    }

    function localReply(input, context, personality, moodTracker) {
      const emotion = detectEmotion(input);
      moodTracker[emotion] = (moodTracker[emotion] || 0) + 1;

      const responses = {
        Freund: {
          sad: ["Das klingt traurig ðŸ˜”. Willst du mir mehr erzÃ¤hlen?"],
          happy: ["Mega! ðŸ˜„ Was hat dich so gefreut?"],
          stressed: ["Klingt nach Stress. Soll ich dir kleine Tipps geben?"],
          pain: ["Autsch, das klingt schmerzhaft. Was genau tut weh?"],
          fear: ["Oh, das klingt beunruhigend. Wovor hast du Angst?"],
          neutral: ["Ich hÃ¶re dir zu. ErzÃ¤hl mir mehr."]
        }
      };

      const replyList = (responses[personality] && responses[personality][emotion]) || responses["Freund"]["neutral"];
      return replyList[Math.floor(Math.random() * replyList.length)];
    }

    async function gptReply(input, messages, personality, apiKey) {
      if (!apiKey) return null;

      const systemPrompt = `Du bist BuddyKI, ein empathischer KI-Coach und Freund. PersÃ¶nlichkeit: ${personality}. Sei einfÃ¼hlsam, klar und hilfreich.`;

      try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${apiKey}`,
          },
          body: JSON.stringify({
            model: "gpt-4o-mini",
            messages: [
              { role: "system", content: systemPrompt },
              ...messages.map(m => ({
                role: m.sender === "user" ? "user" : "assistant",
                content: m.text,
              })),
              { role: "user", content: input },
            ],
          }),
        });

        const data = await response.json();
        if (data.error) return `API-Fehler: ${data.error.message}`;
        if (data.choices && data.choices.length > 0) return data.choices[0].message.content;

        return "Unbekannter Fehler von der API.";
      } catch (err) {
        return `Fehler beim API-Aufruf: ${err.message}`;
      }
    }

    function Avatar() {
      return <div style={{ fontSize: 48, textAlign: "center" }}>ðŸ˜Š</div>;
    }

    function App() {
      const [messages, setMessages] = useState(() => {
        const saved = localStorage.getItem("chatHistory");
        return saved ? JSON.parse(saved) : [{
          sender: "ai",
          text: "Hallo! Ich bin BuddyKI, dein KI-Coach. Welche PersÃ¶nlichkeit wÃ¼nschst du dir heute?"
        }];
      });
      const [input, setInput] = useState("");
      const [personality, setPersonality] = useState("Freund");
      const [apiKey, setApiKey] = useState(localStorage.getItem("apiKey") || "");
      const [moodTracker, setMoodTracker] = useState({});

      useEffect(() => {
        localStorage.setItem("chatHistory", JSON.stringify(messages));
      }, [messages]);

      useEffect(() => {
        localStorage.setItem("apiKey", apiKey);
      }, [apiKey]);

      const handleSend = async () => {
        if (!input) return;
        const userMessage = input;
        setMessages(prev => [...prev, { sender: "user", text: userMessage }]);
        setInput("");

        const lower = userMessage.toLowerCase();
        if (lower.includes("coach")) setPersonality("Coach");
        if (lower.includes("freund")) setPersonality("Freund");
        if (lower.includes("mentor")) setPersonality("Mentor");

        const mood = { ...moodTracker };
        let reply = localReply(userMessage, messages, personality, mood);

        const gptAnswer = await gptReply(userMessage, messages, personality, apiKey);
        if (gptAnswer) reply = gptAnswer;

        setMoodTracker(mood);
        setMessages(prev => [...prev, { sender: "ai", text: reply }]);
      };

      const newChat = () => {
        localStorage.removeItem("chatHistory");
        setMessages([{ sender: "ai", text: "Neuer Start ðŸš€ â€“ Hallo, ich bin BuddyKI! Welche PersÃ¶nlichkeit wÃ¼nschst du dir heute?" }]);
        setMoodTracker({});
      };

      return (
        <div>
          <h2>ðŸ¤– BuddyKI â€“ Dein KI-Coach</h2>
          <Avatar />
          <p>PersÃ¶nlichkeit: <b>{personality}</b> (schreibe â€žCoachâ€œ, â€žFreundâ€œ oder â€žMentorâ€œ)</p>
          <p>
            GPT-API-Key:{" "}
            <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} style={{ width: "60%" }} />
          </p>
          <button onClick={newChat} style={{ marginBottom: 10 }}>ðŸ†• Neuer Chat</button>

          <div className="chat">
            {messages.map((msg, i) => (
              <div key={i} className={"msg " + (msg.sender === "user" ? "user" : "")}>
                <span className="bubble">{msg.text}</span>
              </div>
            ))}
          </div>

          <div style={{ display: "flex", gap: 8 }}>
            <input
              value={input}
              onChange={e => setInput(e.target.value)}
              placeholder="Schreibe etwas..."
              style={{ flex: 1, padding: 8, borderRadius: 8, border: "1px solid #ccc" }}
              onKeyDown={e => { if (e.key === "Enter") handleSend(); }}
            />
            <button onClick={handleSend}>Senden</button>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
