<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>csKI Chat</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #f0f2f5, #dfe9f3);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #root {
      flex: 1;
      padding: 10px;
      display: flex;
      flex-direction: column;
    }
    .chat {
      border: 1px solid #ccc;
      border-radius: 12px;
      padding: 10px;
      flex: 1;
      overflow-y: auto;
      margin-bottom: 10px;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      scroll-behavior: smooth;
    }
    .msg {
      margin: 8px 0;
    }
    .msg.user {
      text-align: right;
    }
    .bubble {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 16px;
      background: #eee;
      max-width: 80%;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .msg.user .bubble {
      background: #007bff;
      color: #fff;
    }
    input {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      flex: 1;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #0056b3;
    }
    h2 {
      text-align: center;
      margin-top: 0;
    }
    p {
      text-align: center;
    }
  </style>
</head>
<body>
  <header style="background:#fff;padding:10px;display:flex;align-items:center;justify-content:space-between;">
    <img src="mascot.png" alt="csKI Maskottchen" style="height:40px;" />
    <img src="logo.png" alt="csKI Logo" style="height:40px;" />
    <div style="position:relative;">
      <button id="menu-button" style="background:none;border:none;font-size:24px;cursor:pointer;">â˜°</button>
      <div id="menu-dropdown" style="display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid #ccc;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <div style="padding:10px;cursor:pointer;" onclick="window.newChat()">Neuer Chat</div>
      </div>
    </div>
  </header>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const API_KEY = "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"; // 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

    function detectEmotion(input) {
      const text = input.toLowerCase();
      if (text.match(/traurig|einsam|deprimiert/)) return "sad";
      if (text.match(/glÃ¼cklich|freude|zufrieden/)) return "happy";
      if (text.match(/stress|arbeit|Ã¼berlastet/)) return "stressed";
      if (text.match(/schmerz|weh|verletzung/)) return "pain";
      if (text.match(/angst|sorge|unsicher/)) return "fear";
      return "neutral";
    }

    function localReply(input, context, personality, moodTracker) {
      const emotion = detectEmotion(input);
      moodTracker[emotion] = (moodTracker[emotion] || 0) + 1;

      const responses = {
        Freund: {
          sad: ["Das klingt traurig ðŸ˜”. Willst du mir mehr erzÃ¤hlen?"],
          happy: ["Mega! ðŸ˜„ Was hat dich so gefreut?"],
          stressed: ["Klingt nach Stress. Soll ich dir kleine Tipps geben?"],
          pain: ["Autsch, das klingt schmerzhaft. Was genau tut weh?"],
          fear: ["Oh, das klingt beunruhigend. Wovor hast du Angst?"],
          neutral: ["Ich hÃ¶re dir zu. ErzÃ¤hl mir mehr."]
        }
      };

      const replyList = (responses[personality] && responses[personality][emotion]) || responses["Freund"]["neutral"];
      return replyList[Math.floor(Math.random() * replyList.length)];
    }

    async function gptReply(input, messages, personality) {
      if (!API_KEY) return null;

      const systemPrompt = `Du bist csKI, ein empathischer KI-Coach und Freund. PersÃ¶nlichkeit: ${personality}. Sei einfÃ¼hlsam, klar und hilfreich.`;

      try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${API_KEY}`,
          },
          body: JSON.stringify({
            model: "gpt-4o-mini",
            messages: [
              { role: "system", content: systemPrompt },
              ...messages.map(m => ({
                role: m.sender === "user" ? "user" : "assistant",
                content: m.text,
              })),
              { role: "user", content: input },
            ],
          }),
        });

        const data = await response.json();
        if (data.error) return `API-Fehler: ${data.error.message}`;
        if (data.choices && data.choices.length > 0) return data.choices[0].message.content;

        return "Unbekannter Fehler von der API.";
      } catch (err) {
        return `Fehler beim API-Aufruf: ${err.message}`;
      }
    }

    function App() {
      const [messages, setMessages] = useState(() => {
        const saved = localStorage.getItem("chatHistory");
        return saved ? JSON.parse(saved) : [{
          sender: "ai",
          text: "Hallo, ich bin Card Service KI, wie kann ich dir helfen?"
        }];
      });
      const [input, setInput] = useState("");
      const [personality, setPersonality] = useState("Freund");
      const [moodTracker, setMoodTracker] = useState({});
      const chatRef = useRef(null);

      useEffect(() => {
        localStorage.setItem("chatHistory", JSON.stringify(messages));
        if (chatRef.current) {
          chatRef.current.scrollTo({ top: chatRef.current.scrollHeight, behavior: "smooth" });
        }
      }, [messages]);

      const handleSend = async () => {
        if (!input) return;
        const userMessage = input;
        setMessages(prev => [...prev, { sender: "user", text: userMessage }]);
        setInput("");

        const lower = userMessage.toLowerCase();
        if (lower.includes("coach")) setPersonality("Coach");
        if (lower.includes("freund")) setPersonality("Freund");
        if (lower.includes("mentor")) setPersonality("Mentor");

        const mood = { ...moodTracker };
        let reply = localReply(userMessage, messages, personality, mood);

        const gptAnswer = await gptReply(userMessage, messages, personality);
        if (gptAnswer) reply = gptAnswer;

        setMoodTracker(mood);
        setMessages(prev => [...prev, { sender: "ai", text: reply }]);
      };

      const newChat = () => {
        localStorage.removeItem("chatHistory");
        setMessages([{ sender: "ai", text: "Hallo, ich bin Card Service KI, wie kann ich dir helfen?" }]);
        setMoodTracker({});
      };

      useEffect(() => {
        window.newChat = newChat;
      }, [newChat]);

        return (
          <>
            <div className="chat" ref={chatRef}>
              {messages.map((msg, i) => (
                <div key={i} className={"msg " + (msg.sender === "user" ? "user" : "")}> 
                  <span className="bubble">{msg.text}</span>
                </div>
              ))}
            </div>

            <div style={{ display: "flex", gap: 8 }}>
              <input
                value={input}
                onChange={e => setInput(e.target.value)}
                placeholder="Schreibe etwas..."
                onKeyDown={e => { if (e.key === "Enter") handleSend(); }}
              />
              <button onClick={handleSend}>Senden</button>
            </div>
          </>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);

      const menuButton = document.getElementById("menu-button");
      const menuDropdown = document.getElementById("menu-dropdown");
      menuButton.addEventListener("click", e => {
        e.stopPropagation();
        menuDropdown.style.display = menuDropdown.style.display === "block" ? "none" : "block";
      });
      document.addEventListener("click", () => {
        menuDropdown.style.display = "none";
      });
  </script>
</body>
</html>
